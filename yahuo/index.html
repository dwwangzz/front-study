<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>商品价格计算器</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: "Microsoft YaHei", sans-serif;
      background: #f8f9fa;
      margin: 0;
      padding: 10px;
      font-size: 16px;
    }
    h1 {
      text-align: center;
      color: #333;
      font-size: 22px;
    }
    .table-container {
      width: 100%;
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      min-width: 900px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 15px;
    }
    th { background: #f1f1f1; }
    input {
      width: 60px;
      padding: 5px;
      text-align: center;
      font-size: 15px;
    }
    .btn {
      display: inline-block;
      padding: 10px 16px;
      margin: 5px;
      font-size: 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: #4caf50;
      color: white;
    }
    .btn:hover { background: #45a049; }
    .btn-danger { background: #f44336; }
    .btn-danger:hover { background: #d32f2f; }
    .records {
      margin-top: 20px;
      background: #fff;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .record-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 5px 0;
      padding: 6px;
      background: #e3f2fd;
      border-radius: 6px;
    }
    .record-btn {
      flex: 1;
      margin-right: 10px;
      padding: 6px;
      background: #2196f3;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 15px;
      text-align: left;
    }
    .record-btn:hover { background: #1976d2; }
    .totals {
      margin-top: 15px;
      text-align: center;
      font-size: 18px;
    }
    #totalPrice, #lossTotal, #leftTotal {
      font-weight: bold;
      color: #e91e63;
      font-size: 20px;
    }
  </style>
</head>
<body>
  <h1>商品价格计算器</h1>
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>商品</th>
          <th>单价</th>
          <th>数量</th>
          <th>损耗</th>
          <th>剩余</th>
          <th>小计</th>
          <th>损耗金额</th>
          <th>剩余金额</th>
        </tr>
      </thead>
      <tbody id="goodsTable"></tbody>
    </table>
  </div>
  <div style="text-align:center;">
      <button class="btn" onclick="saveRecord()">保存记录</button>
      <button class="btn" onclick="exportCSV()">导出报表</button>
      <button class="btn" onclick="resetForm()">重置表单</button>
      <!-- <button class="btn btn-danger" onclick="clearRecords()">清空所有记录</button> -->
  </div>

  <div class="totals">
    总价：<span id="totalPrice">0</span> 元<br>
    损耗金额：<span id="lossTotal">0</span> 元<br>
    剩余金额：<span id="leftTotal">0</span> 元
  </div>
  <div class="records">
    <h3>保存的记录</h3>
    <div id="recordList"></div>
  </div>

  <script>
    const goods = [
      { name: "鸭脖", price: 5 },
      { name: "鸭头", price: 5 },
      { name: "鸦翅", price: 2 },
      { name: "鸭掌", price: 2 },
      { name: "锁骨", price: 3 },
      { name: "鸭胗", price: 2 },
      { name: "鸭心", price: 2 },
      { name: "菜(串)", price: 1 },
      { name: "鸭肠", price: 2 },
      { name: "肉肠", price: 8 },
      { name: "鸭肝", price: 2 },
      { name: "鸭腿", price: 7 }
    ];

    const tbody = document.getElementById("goodsTable");

    goods.forEach((g, i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${g.name}</td>
        <td><input type="number" value="${g.price}" id="price_${i}"></td>
        <td><input type="number" value="0" id="qty_${i}"></td>
        <td><input type="number" value="0" id="loss_${i}"></td>
        <td><input type="number" value="0" id="left_${i}"></td>
        <td id="subtotal_${i}">0</td>
        <td id="lossPrice_${i}">0</td>
        <td id="leftPrice_${i}">0</td>
      `;
      tbody.appendChild(tr);
    });

    // 实时计算
    document.querySelectorAll("input").forEach(input => {
      input.addEventListener("input", calculate);
    });

    function calculate() {
      let total = 0, lossTotal = 0, leftTotal = 0;
      goods.forEach((g, i) => {
        const price = parseFloat(document.getElementById(`price_${i}`).value) || 0;
        const qty = parseFloat(document.getElementById(`qty_${i}`).value) || 0;
        const loss = parseFloat(document.getElementById(`loss_${i}`).value) || 0;
        const left = parseFloat(document.getElementById(`left_${i}`).value) || 0;
        const subtotal = Math.max(0, (qty - loss - left)) * price;
        const lossPrice = loss * price;
        const leftPrice = left * price;
        document.getElementById(`subtotal_${i}`).innerText = subtotal.toFixed(2);
        document.getElementById(`lossPrice_${i}`).innerText = lossPrice.toFixed(2);
        document.getElementById(`leftPrice_${i}`).innerText = leftPrice.toFixed(2);
        total += subtotal;
        lossTotal += lossPrice;
        leftTotal += leftPrice;
      });
      document.getElementById("totalPrice").innerText = total.toFixed(2);
      document.getElementById("lossTotal").innerText = lossTotal.toFixed(2);
      document.getElementById("leftTotal").innerText = leftTotal.toFixed(2);
    }

    function saveRecord() {
      calculate();
      const record = goods.map((g, i) => ({
        price: document.getElementById(`price_${i}`).value,
        qty: document.getElementById(`qty_${i}`).value,
        loss: document.getElementById(`loss_${i}`).value,
        left: document.getElementById(`left_${i}`).value
      }));
      let records = JSON.parse(localStorage.getItem("records") || "[]");
      records.unshift({ time: new Date().toLocaleString(), data: record });
      if (records.length > 10) records = records.slice(0, 10);
      localStorage.setItem("records", JSON.stringify(records));
      renderRecords();
    }

    function renderRecords() {
      const recordList = document.getElementById("recordList");
      recordList.innerHTML = "";
      const records = JSON.parse(localStorage.getItem("records") || "[]");
      records.forEach((rec, idx) => {
        const div = document.createElement("div");
        div.className = "record-item";
        div.innerHTML = `
          <button class="record-btn" onclick="loadRecord(${idx})">
            记录 ${idx + 1} - ${rec.time}
          </button>
          <button class="btn btn-danger" onclick="deleteRecord(${idx})">删除</button>
        `;
        recordList.appendChild(div);
      });
    }

    function loadRecord(index) {
      const records = JSON.parse(localStorage.getItem("records") || "[]");
      const rec = records[index];
      if (!rec) return;
      rec.data.forEach((r, i) => {
        document.getElementById(`price_${i}`).value = r.price;
        document.getElementById(`qty_${i}`).value = r.qty;
        document.getElementById(`loss_${i}`).value = r.loss;
        document.getElementById(`left_${i}`).value = r.left;
      });
      calculate();
    }

    function deleteRecord(index) {
      let records = JSON.parse(localStorage.getItem("records") || "[]");
      records.splice(index, 1);
      localStorage.setItem("records", JSON.stringify(records));
      renderRecords();
    }

    function clearRecords() {
      if (confirm("确定要清空所有记录吗？")) {
        localStorage.removeItem("records");
        renderRecords();
      }
    }

    // 导出 CSV
    function exportCSV() {
      calculate();
      let csv = "商品,单价,数量,损耗,剩余,小计,损耗金额,剩余金额\n";
      goods.forEach((g, i) => {
        const price = document.getElementById(`price_${i}`).value;
        const qty = document.getElementById(`qty_${i}`).value;
        const loss = document.getElementById(`loss_${i}`).value;
        const left = document.getElementById(`left_${i}`).value;
        const subtotal = document.getElementById(`subtotal_${i}`).innerText;
        const lossPrice = document.getElementById(`lossPrice_${i}`).innerText;
        const leftPrice = document.getElementById(`leftPrice_${i}`).innerText;
        csv += `${g.name},${price},${qty},${loss},${left},${subtotal},${lossPrice},${leftPrice}\n`;
      });
      csv += `合计,,,,,${document.getElementById("totalPrice").innerText},${document.getElementById("lossTotal").innerText},${document.getElementById("leftTotal").innerText}\n`;

      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      const date = new Date().toISOString().slice(0, 10);
      link.href = URL.createObjectURL(blob);
      link.download = `价格记录_${date}.csv`;
      link.click();
    }

    // 输入框聚焦时自动全选
    function selectAllText(event) {
        event.target.select();
    }

    // 页面加载时给所有输入框绑定事件
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll("input[type='number'], input[type='text']")
            .forEach(input => {
                input.addEventListener("focus", selectAllText);
            });
    });

    // 重置表单
    function resetForm() {
        goods.forEach((g, i) => {
            document.getElementById(`price_${i}`).value = g.price; // 单价回填默认
            document.getElementById(`qty_${i}`).value = 0;
            document.getElementById(`loss_${i}`).value = 0;
            document.getElementById(`left_${i}`).value = 0;
            document.getElementById(`subtotal_${i}`).innerText = "0";
            document.getElementById(`lossPrice_${i}`).innerText = "0";
            document.getElementById(`leftPrice_${i}`).innerText = "0";
        });
        document.getElementById("totalPrice").innerText = "0";
        document.getElementById("lossTotal").innerText = "0";
        document.getElementById("leftTotal").innerText = "0";
    }

    renderRecords();
    calculate();
  </script>
</body>
</html>
